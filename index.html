<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crack The Code - Math Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #5a67d8;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .instructions {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .puzzles-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 40px;
        }

        .puzzle-word {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            transition: transform 0.3s ease;
            width: 100%;
            overflow-x: auto;
        }

        .puzzle-word:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .word-title {
            font-size: 1.2em;
            color: #4a5568;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .puzzle-grid {
            display: inline-grid;
            gap: 10px;
            min-width: min-content;
        }

        .puzzle-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .math-problem {
            background: white;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            font-size: 1em;
            color: #2d3748;
            font-weight: bold;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answer-input, .letter-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.2em;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .answer-input:focus, .letter-input:focus {
            outline: none;
            border-color: #667eea;
            transform: scale(1.1);
        }

        .answer-input.correct, .letter-input.correct {
            background: #c6f6d5;
            border-color: #48bb78;
            color: #22543d;
        }

        .answer-input.incorrect, .letter-input.incorrect {
            background: #fed7d7;
            border-color: #f56565;
            color: #742a2a;
        }

        .legend-container {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
        }

        .legend-title {
            text-align: center;
            color: white;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .legend-item {
            background: white;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: #2d3748;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .legend-item:hover {
            transform: scale(1.1);
        }

        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: transform 0.5s ease;
        }

        .success-message.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .reset-button {
            display: block;
            margin: 30px auto 0;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .reset-button:hover {
            transform: scale(1.05);
        }

        .level-selector {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .level-selector h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .level-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .level-button {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
            max-width: 200px;
        }

        .level-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .level-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .level-name {
            display: block;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .level-desc {
            display: block;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .print-button {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
            border: none;
            border-radius: 30px;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: transform 0.3s ease;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .print-button:hover {
            transform: scale(1.05);
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white !important;
                margin: 0 !important;
                padding: 10px !important;
            }

            .game-container {
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 10px !important;
                max-width: 100% !important;
            }

            h1 {
                font-size: 1.8em !important;
                color: black !important;
                text-shadow: none !important;
                margin-bottom: 10px !important;
            }

            .level-selector, .reset-button, .print-button, .success-message {
                display: none !important;
            }

            .print-info {
                display: block !important;
                text-align: center;
                margin-bottom: 15px;
                font-size: 0.9em;
                color: #666;
            }

            .instructions {
                font-size: 0.9em !important;
                margin-bottom: 15px !important;
                color: black !important;
            }

            .puzzles-container {
                gap: 15px !important;
                margin-bottom: 20px !important;
            }

            .puzzle-word {
                background: white !important;
                border: 2px solid #333 !important;
                padding: 10px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .puzzle-word:hover {
                transform: none !important;
                box-shadow: none !important;
            }

            .word-title {
                font-size: 1em !important;
                color: black !important;
                margin-bottom: 8px !important;
            }

            .puzzle-grid {
                gap: 5px !important;
            }

            .puzzle-item {
                gap: 3px !important;
            }

            .math-problem {
                border: 1px solid #333 !important;
                background: white !important;
                padding: 5px !important;
                font-size: 0.9em !important;
                color: black !important;
                min-height: 25px !important;
            }

            .answer-input, .letter-input {
                width: 35px !important;
                height: 35px !important;
                border: 2px solid #333 !important;
                background: white !important;
                font-size: 1em !important;
                color: black !important;
            }

            .answer-input.correct, .letter-input.correct {
                background: white !important;
                border-color: #333 !important;
                color: black !important;
            }

            .answer-input.incorrect, .letter-input.incorrect {
                background: white !important;
                border-color: #333 !important;
                color: black !important;
            }

            .legend-container {
                background: white !important;
                border: 2px solid #333 !important;
                padding: 10px !important;
                margin-top: 15px !important;
                page-break-inside: avoid !important;
            }

            .legend-title {
                font-size: 1.1em !important;
                color: black !important;
                text-shadow: none !important;
                margin-bottom: 10px !important;
            }

            .legend-grid {
                gap: 5px !important;
            }

            .legend-item {
                background: white !important;
                border: 1px solid #333 !important;
                padding: 5px !important;
                font-size: 0.9em !important;
                color: black !important;
                box-shadow: none !important;
            }

            .legend-item:hover {
                transform: none !important;
            }

            /* Ensure everything fits on one page */
            @page {
                size: letter;
                margin: 0.5in;
            }
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 1.8em;
            }
            
            .puzzle-word {
                padding: 15px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .answer-input, .letter-input {
                width: 40px;
                height: 40px;
                font-size: 1em;
            }
            
            .math-problem {
                font-size: 0.9em;
                min-height: 35px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>🔐 Crack The Code 🔐</h1>
        <div class="print-info" id="printInfo" style="display: none;"></div>
        
        <div class="level-selector">
            <h3>Choose Your Level:</h3>
            <div class="level-buttons">
                <button class="level-button active" data-level="1" onclick="selectLevel(1)">
                    <span class="level-name">Level 1</span>
                    <span class="level-desc">Basic math (0-10)</span>
                </button>
                <button class="level-button" data-level="2" onclick="selectLevel(2)">
                    <span class="level-name">Level 2</span>
                    <span class="level-desc">Bigger numbers (0-15)</span>
                </button>
                <button class="level-button" data-level="3" onclick="selectLevel(3)">
                    <span class="level-name">Level 3</span>
                    <span class="level-desc">+, −, × (up to 5×5)</span>
                </button>
            </div>
        </div>
        
        <p class="instructions">Solve the math problems, then use the legend to find the secret letters!</p>
        
        <div class="puzzles-container" id="puzzlesContainer">
            <!-- Puzzles will be generated here -->
        </div>
        
        <div class="legend-container">
            <h2 class="legend-title">🗝️ Number → Letter Legend 🗝️</h2>
            <div class="legend-grid" id="legendGrid">
                <!-- Legend will be generated here -->
            </div>
        </div>
        
        <button class="reset-button" onclick="resetGame()">🎮 New Game</button>
        <button class="print-button" onclick="printWorksheet()">🖨️ Print Worksheet</button>
    </div>
    
    <div class="success-message" id="successMessage">
        🎉 Amazing Job! 🎉<br>You Cracked All The Codes!
    </div>

    <script>
        // Level configurations
        const levelSettings = {
            1: {
                name: "Level 1",
                maxWords: 4,
                maxNumber: 10,
                operations: ['+', '-'],
                allowMultiplication: false,
                description: "Basic addition and subtraction (0-10)"
            },
            2: {
                name: "Level 2", 
                maxWords: 5,
                maxNumber: 15,
                operations: ['+', '-'],
                allowMultiplication: false,
                description: "Larger numbers (0-15)"
            },
            3: {
                name: "Level 3",
                maxWords: 10,
                maxNumber: 25,  // Increased to handle multiplication results
                operations: ['+', '-', '×'],
                allowMultiplication: true,
                multiplicationMaxFactor: 5,  // Max factor for multiplication (5x5=25)
                description: "Advanced with multiplication (up to 5×5)"
            }
        };

        // Sentences organized by difficulty level
        const sentencesByLevel = {
            1: [
                // 2-4 word sentences (50 sentences)
                "I LOVE DOGS", "THE SUN SHINES", "CATS ARE SOFT", "WE GO HOME",
                "I CAN RUN", "BIRDS CAN FLY", "THE SKY BLUE", "I LIKE BOOKS",
                "MOM IS NICE", "DOGS WAG TAILS", "FISH CAN SWIM", "I HAVE EYES",
                "TREES ARE TALL", "I PLAY GAMES", "THE MOON GLOWS", "I EAT FOOD",
                "RAIN IS WET", "I BRUSH TEETH", "BEES MAKE HONEY", "WE NEED SLEEP",
                "DAD IS STRONG", "I CAN COUNT", "FLOWERS SMELL NICE", "GRASS IS GREEN",
                "I RIDE BIKES", "STARS SHINE BRIGHT", "I HAVE HANDS", "SNOW IS COLD",
                "I HELP FRIENDS", "BOOKS ARE FUN", "OCEAN IS BIG", "I WASH HANDS",
                "FROGS JUMP HIGH", "WE EAT LUNCH", "MY ROOM CLEAN", "I LIKE SONGS",
                "CLOUDS ARE WHITE", "WIND CAN BLOW", "I DRAW PICTURES", "PIZZA TASTES GOOD",
                "SHOES ARE RED", "I SHARE TOYS", "BELLS RING LOUD", "BEARS ARE BIG",
                "I KNOW MATH", "PARKS ARE FUN", "I FEED PETS", "APPLES ARE SWEET",
                "WE PLAY OUTSIDE", "MY SISTER KIND"
            ],
            2: [
                // 3-5 word sentences (50 sentences)
                "I LOVE MY BIG DOG", "THE BRIGHT SUN IS HOT", "CATS ARE VERY SOFT PETS",
                "WE GO TO SCHOOL DAILY", "I CAN RUN VERY FAST", "BIRDS FLY IN THE SKY",
                "THE SKY IS BRIGHT BLUE", "I LIKE TO READ BOOKS", "MY MOM IS VERY NICE",
                "DOGS WAG THEIR LONG TAILS", "FISH SWIM IN COLD WATER", "I HAVE TWO BROWN EYES",
                "TALL TREES GROW IN PARKS", "I PLAY WITH MY TOYS", "THE MOON IS VERY WHITE",
                "I EAT GOOD HEALTHY FOOD", "RAIN MAKES US ALL WET", "I BRUSH MY WHITE TEETH",
                "BUSY BEES MAKE SWEET HONEY", "WE NEED TO SLEEP WELL", "MY DAD IS SUPER STRONG",
                "I CAN COUNT TO TWENTY", "PRETTY FLOWERS SMELL SO NICE", "THE GRASS IS VERY GREEN",
                "I RIDE MY NEW BIKE", "STARS SHINE BRIGHT AT NIGHT", "I HAVE TEN SMALL FINGERS",
                "COLD SNOW FALLS IN WINTER", "I HELP MY BEST FRIENDS", "BOOKS ARE REALLY FUN THINGS",
                "THE OCEAN IS VERY BIG", "I WASH MY DIRTY HANDS", "GREEN FROGS JUMP VERY HIGH",
                "WE EAT LUNCH AT NOON", "MY ROOM IS SUPER CLEAN", "I LIKE TO SING SONGS",
                "WHITE CLOUDS FLOAT IN SKY", "THE WIND BLOWS VERY HARD", "I DRAW WITH MANY CRAYONS",
                "CHEESE PIZZA TASTES REALLY GOOD", "MY NEW SHOES ARE RED", "I SHARE ALL MY TOYS",
                "THE SCHOOL BELL RINGS LOUD", "BIG BEARS LIVE IN FORESTS", "I KNOW MY FULL NAME",
                "THE PARK IS VERY FUN", "I FEED MY HUNGRY PET", "RED APPLES ARE VERY SWEET",
                "WE PLAY OUTSIDE EVERY DAY", "MY LITTLE SISTER IS KIND"
            ],
            3: [
                // 5-10 word sentences (50 sentences)
                "I LOVE TO PLAY WITH MY BIG BROWN DOG EVERY MORNING",
                "THE BRIGHT YELLOW SUN MAKES THE WHOLE WORLD FEEL WARM TODAY",
                "MY FLUFFY WHITE CAT LIKES TO SLEEP ON THE SOFT COUCH",
                "WE GO TO SCHOOL EVERY DAY TO LEARN NEW EXCITING THINGS",
                "I CAN RUN VERY FAST WHEN I PLAY TAG WITH FRIENDS",
                "BEAUTIFUL BIRDS FLY HIGH IN THE BRIGHT BLUE SKY EVERY DAY",
                "THE OCEAN WAVES CRASH ON THE SANDY BEACH ALL DAY LONG",
                "I LIKE TO READ ADVENTURE BOOKS BEFORE I GO TO BED",
                "MY WONDERFUL MOM MAKES THE BEST CHOCOLATE CHIP COOKIES IN TOWN",
                "HAPPY DOGS WAG THEIR TAILS WHEN THEY SEE THEIR LOVING OWNERS",
                "COLORFUL FISH SWIM TOGETHER IN THE DEEP BLUE OCEAN WATER DAILY",
                "I HAVE TWO EYES THAT HELP ME SEE THE BEAUTIFUL WORLD",
                "TALL GREEN TREES GROW IN THE FOREST AND GIVE US OXYGEN",
                "I PLAY WITH MY TOYS IN MY ROOM AFTER SCHOOL ENDS",
                "THE BRIGHT WHITE MOON LIGHTS UP THE DARK NIGHT SKY BEAUTIFULLY",
                "I EAT HEALTHY FOOD TO HELP MY BODY GROW BIG AND STRONG",
                "RAIN MAKES THE FLOWERS GROW AND THE GRASS TURN BRIGHT GREEN",
                "I BRUSH MY TEETH TWICE EVERY DAY TO KEEP THEM CLEAN",
                "BUSY BEES MAKE DELICIOUS HONEY BY VISITING MANY COLORFUL FLOWERS DAILY",
                "WE NEED TO SLEEP EIGHT HOURS TO FEEL GOOD THE NEXT DAY",
                "MY STRONG DAD CAN LIFT HEAVY THINGS AND FIX BROKEN STUFF EASILY",
                "I CAN COUNT TO ONE HUNDRED AND SOLVE MATH PROBLEMS VERY WELL",
                "BEAUTIFUL FLOWERS SMELL NICE AND MAKE OUR GARDEN LOOK VERY PRETTY",
                "THE SOFT GREEN GRASS FEELS GOOD UNDER MY BARE FEET IN SUMMER",
                "I RIDE MY SHINY RED BIKE TO THE PARK EVERY SATURDAY MORNING",
                "BRIGHT STARS SHINE IN THE NIGHT SKY LIKE TINY DIAMONDS ABOVE US",
                "I HAVE TEN FINGERS THAT HELP ME WRITE AND DRAW PICTURES WELL",
                "COLD WHITE SNOW FALLS FROM THE SKY AND COVERS EVERYTHING IN WINTER",
                "I ALWAYS HELP MY FRIENDS WHEN THEY NEED SOMEONE TO TALK TO",
                "READING BOOKS IS FUN AND HELPS US LEARN ABOUT THE WHOLE WORLD",
                "THE PACIFIC OCEAN IS THE BIGGEST BODY OF WATER ON PLANET EARTH",
                "I WASH MY HANDS WITH SOAP BEFORE EATING TO STAY HEALTHY ALWAYS",
                "GREEN FROGS JUMP HIGH AND CATCH FLIES WITH THEIR LONG STICKY TONGUES",
                "WE EAT LUNCH IN THE CAFETERIA WITH ALL OUR FRIENDS AT NOON",
                "MY BEDROOM IS CLEAN BECAUSE I PUT AWAY ALL MY TOYS DAILY",
                "I LIKE TO SING HAPPY SONGS WHEN I TAKE A WARM BATH",
                "WHITE FLUFFY CLOUDS FLOAT SLOWLY ACROSS THE BRIGHT BLUE SKY ALL DAY",
                "THE STRONG WIND BLOWS THE AUTUMN LEAVES OFF ALL THE TALL TREES",
                "I DRAW COLORFUL PICTURES WITH MY NEW BOX OF CRAYONS AFTER SCHOOL",
                "DELICIOUS CHEESE PIZZA WITH PEPPERONI IS MY FAVORITE FOOD TO EAT",
                "MY NEW RED SHOES HELP ME RUN FASTER THAN EVER BEFORE NOW",
                "I SHARE MY TOYS WITH MY LITTLE BROTHER BECAUSE I LOVE HIM",
                "THE LOUD SCHOOL BELL RINGS TO TELL US WHEN CLASS IS OVER",
                "BIG BROWN BEARS LIVE IN THE FOREST AND EAT FISH FROM RIVERS",
                "I KNOW MY FULL NAME AND ADDRESS IN CASE I GET LOST",
                "THE PLAYGROUND AT THE PARK IS FUN WITH SWINGS AND SLIDES",
                "I FEED MY HUNGRY PET RABBIT FRESH CARROTS AND LETTUCE EVERY DAY",
                "SWEET RED APPLES GROW ON TREES IN THE ORCHARD NEAR MY HOUSE",
                "WE PLAY OUTSIDE IN THE SUNSHINE WHEN THE WEATHER IS NICE",
                "MY LITTLE SISTER IS KIND AND SHARES HER TOYS WITH ME"
            ]
        };

        // All possible letters we might use
        const allLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
        
        let currentLevel = 1;
        let currentLegend = {};
        let currentSentence = "";
        let totalProblems = 0;
        let correctAnswers = 0;

        // Function to generate a shuffled legend
        function generateShuffledLegend() {
            const legend = {};
            const usedLetters = new Set();
            const maxNum = levelSettings[currentLevel].maxNumber;
            
            // Get unique letters from the current sentence
            currentSentence.split('').forEach(char => {
                if (char !== ' ' && !usedLetters.has(char)) {
                    usedLetters.add(char);
                }
            });
            
            // Convert to array and shuffle
            const lettersArray = Array.from(usedLetters);
            const shuffledLetters = [...lettersArray].sort(() => Math.random() - 0.5);
            
            // Assign numbers 0-maxNum to letters
            shuffledLetters.forEach((letter, index) => {
                if (index <= maxNum) {
                    legend[index] = letter;
                }
            });
            
            // Fill remaining spots (if sentence has fewer unique letters than maxNum+1)
            let nextIndex = shuffledLetters.length;
            for (let i = 0; i < allLetters.length && nextIndex <= maxNum; i++) {
                if (!usedLetters.has(allLetters[i])) {
                    legend[nextIndex] = allLetters[i];
                    nextIndex++;
                }
            }
            
            return legend;
        }

        // Function to generate math problems
        function generateMathProblem(targetNumber) {
            const settings = levelSettings[currentLevel];
            const operations = settings.operations;
            const maxNum = settings.maxNumber;
            
            // For multiplication in level 3, occasionally use multiplication
            if (settings.allowMultiplication && Math.random() < 0.35) {
                // Try to find multiplication factors up to 5
                const factors = [];
                const maxFactor = settings.multiplicationMaxFactor;
                
                for (let i = 2; i <= maxFactor; i++) {
                    if (targetNumber % i === 0) {
                        const otherFactor = targetNumber / i;
                        if (otherFactor <= maxFactor && otherFactor >= 2) {
                            factors.push([i, otherFactor]);
                        }
                    }
                }
                
                // Also allow simple multiplications that equal the target
                if (targetNumber <= maxFactor * maxFactor) {
                    for (let i = 1; i <= maxFactor; i++) {
                        for (let j = i; j <= maxFactor; j++) {
                            if (i * j === targetNumber) {
                                factors.push([i, j]);
                            }
                        }
                    }
                }
                
                if (factors.length > 0) {
                    const [a, b] = factors[Math.floor(Math.random() * factors.length)];
                    return `${a} × ${b}`;
                }
            }
            
            // Use addition or subtraction
            const operation = operations.filter(op => op !== '×')[Math.floor(Math.random() * 2)];
            
            let a, b;
            if (operation === '+') {
                // For addition, ensure result doesn't exceed 20 for level 3
                const addMax = Math.min(20, maxNum);
                if (targetNumber <= addMax) {
                    a = Math.floor(Math.random() * (targetNumber + 1));
                    b = targetNumber - a;
                } else {
                    // For numbers > 20, use larger addition
                    a = 10 + Math.floor(Math.random() * 11);
                    b = targetNumber - a;
                }
            } else {
                // For subtraction, ensure we don't get negative numbers
                const subMax = Math.min(20, maxNum);
                a = targetNumber + Math.floor(Math.random() * (subMax - targetNumber + 1));
                b = a - targetNumber;
            }
            
            return `${a} ${operation} ${b}`;
        }

        function initGame() {
            totalProblems = 0;
            correctAnswers = 0;
            
            // Select a random sentence from the current level
            const levelSentences = sentencesByLevel[currentLevel];
            currentSentence = levelSentences[Math.floor(Math.random() * levelSentences.length)];
            
            // Generate shuffled legend
            currentLegend = generateShuffledLegend();
            
            // Split sentence into words
            const words = currentSentence.split(' ');
            
            // Generate puzzles
            const puzzlesContainer = document.getElementById('puzzlesContainer');
            puzzlesContainer.innerHTML = '';
            
            words.forEach((word, wordIndex) => {
                const wordDiv = document.createElement('div');
                wordDiv.className = 'puzzle-word';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'word-title';
                titleDiv.textContent = `Word ${wordIndex + 1}`;
                wordDiv.appendChild(titleDiv);
                
                const gridDiv = document.createElement('div');
                gridDiv.className = 'puzzle-grid';
                gridDiv.style.gridTemplateColumns = `repeat(${word.length}, minmax(60px, 1fr))`;
                
                word.split('').forEach((letter, letterIndex) => {
                    totalProblems += 2; // Count both answer and letter inputs
                    
                    // Find which number corresponds to this letter
                    let targetNumber = null;
                    for (let [num, leg] of Object.entries(currentLegend)) {
                        if (leg === letter) {
                            targetNumber = parseInt(num);
                            break;
                        }
                    }
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'puzzle-item';
                    
                    const mathDiv = document.createElement('div');
                    mathDiv.className = 'math-problem';
                    mathDiv.textContent = generateMathProblem(targetNumber);
                    
                    const answerInput = document.createElement('input');
                    answerInput.type = 'text';
                    answerInput.className = 'answer-input';
                    answerInput.placeholder = '';
                    answerInput.maxLength = 2;
                    answerInput.dataset.correct = targetNumber.toString();
                    answerInput.dataset.wordIndex = wordIndex;
                    answerInput.dataset.letterIndex = letterIndex;
                    answerInput.dataset.type = 'answer';
                    
                    const letterInput = document.createElement('input');
                    letterInput.type = 'text';
                    letterInput.className = 'letter-input';
                    letterInput.placeholder = '';
                    letterInput.maxLength = 1;
                    letterInput.dataset.correct = letter;
                    letterInput.dataset.wordIndex = wordIndex;
                    letterInput.dataset.letterIndex = letterIndex;
                    letterInput.dataset.type = 'letter';
                    
                    // Add event listeners
                    answerInput.addEventListener('input', handleInput);
                    letterInput.addEventListener('input', handleInput);
                    
                    itemDiv.appendChild(mathDiv);
                    itemDiv.appendChild(answerInput);
                    itemDiv.appendChild(letterInput);
                    gridDiv.appendChild(itemDiv);
                });
                
                wordDiv.appendChild(gridDiv);
                puzzlesContainer.appendChild(wordDiv);
            });
            
            // Generate legend display
            const legendGrid = document.getElementById('legendGrid');
            legendGrid.innerHTML = '';
            
            // Sort legend by number for display
            const sortedLegend = Object.entries(currentLegend)
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            sortedLegend.forEach(([num, letter]) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.textContent = `${num} → ${letter}`;
                legendGrid.appendChild(legendItem);
            });
        }

        function selectLevel(level) {
            currentLevel = level;
            
            // Update button states
            document.querySelectorAll('.level-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-level="${level}"]`).classList.add('active');
            
            // Start new game with selected level
            initGame();
        }

        function handleInput(event) {
            const input = event.target;
            const value = input.value.toUpperCase();
            const correct = input.dataset.correct.toUpperCase();
            
            if (value === '') {
                input.classList.remove('correct', 'incorrect');
                return;
            }
            
            if (value === correct) {
                if (!input.classList.contains('correct')) {
                    input.classList.remove('incorrect');
                    input.classList.add('correct');
                    correctAnswers++;
                    
                    // Check if all problems are solved
                    if (correctAnswers === totalProblems) {
                        showSuccess();
                    }
                }
            } else {
                input.classList.remove('correct');
                input.classList.add('incorrect');
                
                // If it was previously correct, decrease the count
                if (input.dataset.wasCorrect === 'true') {
                    correctAnswers--;
                }
            }
            
            input.dataset.wasCorrect = value === correct ? 'true' : 'false';
        }

        function showSuccess() {
            const successMessage = document.getElementById('successMessage');
            successMessage.classList.add('show');
            
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 3000);
        }

        function resetGame() {
            initGame();
        }

        function printWorksheet() {
            // Clear any user inputs before printing for a clean worksheet
            const inputs = document.querySelectorAll('.answer-input, .letter-input');
            inputs.forEach(input => {
                input.classList.remove('correct', 'incorrect');
                input.value = '';
            });
            
            // Add print information
            const printInfo = document.getElementById('printInfo');
            const today = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const levelName = levelSettings[currentLevel].name;
            printInfo.innerHTML = `${levelName} - ${today} - Name: ___________________`;
            
            // Add a small delay to ensure DOM updates, then print
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Initialize the game when the page loads
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
